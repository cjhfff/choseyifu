<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI æ¥å£è¯Šæ–­å·¥å…·</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        h1 {
            color: #333;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }
        .test-section {
            margin: 30px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }
        .test-title {
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
            font-size: 16px;
        }
        .status {
            padding: 10px 15px;
            border-radius: 5px;
            margin: 10px 0;
            font-size: 14px;
        }
        .status.pending {
            background: #fff3cd;
            color: #856404;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
        }
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
        }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin: 10px 5px;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .image-upload {
            margin: 20px 0;
        }
        .upload-area {
            border: 2px dashed #667eea;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        .upload-area:hover {
            background: #f8f9ff;
            border-color: #764ba2;
        }
        .preview-image {
            max-width: 200px;
            max-height: 200px;
            margin: 20px auto;
            display: block;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        pre {
            background: #2d3748;
            color: #68d391;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            font-size: 12px;
            max-height: 300px;
        }
        .solution {
            background: #e7f3ff;
            border-left: 4px solid #2196F3;
            padding: 20px;
            margin: 20px 0;
            border-radius: 5px;
        }
        .solution h3 {
            color: #1976D2;
            margin-bottom: 10px;
        }
        .solution ol {
            margin-left: 20px;
            color: #333;
        }
        .solution li {
            margin: 10px 0;
            line-height: 1.6;
        }
        .solution code {
            background: #f5f5f5;
            padding: 2px 6px;
            border-radius: 3px;
            color: #d73a49;
            font-family: 'Courier New', monospace;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ AI æ¥å£è¯Šæ–­å·¥å…·</h1>
        <p class="subtitle">æ£€æµ‹ä½ çš„ AI è¯†åˆ«æ¥å£æ˜¯å¦æ­£å¸¸å·¥ä½œ</p>

        <!-- æµ‹è¯•1: ç¯å¢ƒæ£€æµ‹ -->
        <div class="test-section">
            <div class="test-title">ğŸ“‹ æ­¥éª¤ 1: ç¯å¢ƒæ£€æµ‹</div>
            <div id="env-status" class="status pending">ç­‰å¾…æ£€æµ‹...</div>
            <button onclick="checkEnvironment()">å¼€å§‹æ£€æµ‹</button>
        </div>

        <!-- æµ‹è¯•2: API è¿é€šæ€§ -->
        <div class="test-section">
            <div class="test-title">ğŸŒ æ­¥éª¤ 2: API è¿é€šæ€§æµ‹è¯•</div>
            <div id="api-status" class="status pending">ç­‰å¾…æµ‹è¯•...</div>
            <button onclick="testAPIConnection()">æµ‹è¯•è¿æ¥</button>
        </div>

        <!-- æµ‹è¯•3: å®é™…å›¾ç‰‡åˆ†æ -->
        <div class="test-section">
            <div class="test-title">ğŸ–¼ï¸ æ­¥éª¤ 3: å®é™…å›¾ç‰‡è¯†åˆ«æµ‹è¯•</div>
            <div class="image-upload">
                <div class="upload-area" onclick="document.getElementById('imageInput').click()">
                    <p>ğŸ“¸ ç‚¹å‡»ä¸Šä¼ æµ‹è¯•å›¾ç‰‡</p>
                    <p style="font-size: 12px; color: #999; margin-top: 10px;">æ”¯æŒæ‹ç…§æˆ–é€‰æ‹©è¡£ç‰©å›¾ç‰‡</p>
                </div>
                <input type="file" id="imageInput" accept="image/*" capture="environment" style="display:none;" onchange="handleImageUpload(event)">
                <img id="preview" class="preview-image" style="display:none;">
            </div>
            <div id="test-status" class="status pending">è¯·å…ˆä¸Šä¼ å›¾ç‰‡</div>
            <button id="testBtn" onclick="testImageAnalysis()" disabled>å¼€å§‹è¯†åˆ«</button>
        </div>

        <!-- ç»“æœå±•ç¤º -->
        <div class="test-section" id="resultSection" style="display:none;">
            <div class="test-title">ğŸ“Š è¯†åˆ«ç»“æœ</div>
            <pre id="resultJson"></pre>
        </div>

        <!-- è§£å†³æ–¹æ¡ˆ -->
        <div class="solution" id="solutionSection" style="display:none;">
            <h3>ğŸ’¡ è§£å†³æ–¹æ¡ˆ</h3>
            <div id="solutionContent"></div>
        </div>
    </div>

    <script>
        let currentImage = null;

        function detectEnvironment() {
            const url = new URL(window.location.href);
            const host = url.hostname;
            const protocol = url.protocol;
            const isFile = protocol === 'file:';
            const isLocalhost = ['localhost', '127.0.0.1'].includes(host);
            const isVercel = host.endsWith('.vercel.app');
            const isPreview = isVercel && host.includes('-git-');
            const isCustomDomain = !isFile && !isLocalhost && !isVercel && protocol.startsWith('http');

            let environmentLabel = 'âš ï¸ æœªçŸ¥éƒ¨ç½²ç¯å¢ƒ';
            let nextStep = '';
            if (isFile) {
                environmentLabel = 'âŒ æœ¬åœ°æ–‡ä»¶æ¨¡å¼ï¼ˆfile://ï¼‰';
                nextStep = 'è¯·ä½¿ç”¨ vercel dev æˆ–éƒ¨ç½²åˆ° Vercel åå†è®¿é—®æœ¬é¡µé¢ã€‚';
            } else if (isLocalhost) {
                environmentLabel = 'âš ï¸ æœ¬åœ°æœåŠ¡å™¨ï¼ˆlocalhostï¼‰';
                nextStep = 'ç¡®ä¿æ˜¯é€šè¿‡ vercel dev æˆ–å…·å¤‡ /api è·¯ç”±çš„æœ¬åœ°æœåŠ¡å¯åŠ¨ã€‚';
            } else if (isVercel) {
                environmentLabel = isPreview ? 'âœ… Vercel é¢„è§ˆéƒ¨ç½²' : 'âœ… Vercel ç”Ÿäº§éƒ¨ç½²';
                nextStep = isPreview ? 'å¦‚éœ€æ­£å¼åŸŸåè®¿é—®ï¼Œå¯åœ¨ Vercel ä¸­ Promote åˆ° Productionã€‚' : 'ç¯å¢ƒæ­£ç¡®ï¼Œå¯ç»§ç»­æµ‹è¯• APIã€‚';
            } else if (isCustomDomain) {
                environmentLabel = 'âš ï¸ è‡ªå®šä¹‰åŸŸå';
                nextStep = 'ç¡®è®¤åŸŸåå·²ç»‘å®šåˆ° Vercel é¡¹ç›®ï¼Œä¸”æ­¤æ–‡ä»¶åŒ…å«åœ¨éƒ¨ç½²åŒ…å†…ã€‚';
            }

            return {
                url: url.href,
                host,
                protocol,
                path: url.pathname,
                isFile,
                isLocalhost,
                isVercel,
                isPreview,
                isCustomDomain,
                environmentLabel,
                nextStep
            };
        }

        // æ­¥éª¤1: ç¯å¢ƒæ£€æµ‹
        function checkEnvironment() {
            const statusDiv = document.getElementById('env-status');
            statusDiv.className = 'status pending';
            statusDiv.innerHTML = 'ğŸ” æ­£åœ¨æ£€æµ‹ç¯å¢ƒ...';

            setTimeout(() => {
                const env = detectEnvironment();
                const results = [];
                results.push(`å½“å‰è®¿é—®åœ°å€: ${env.url}`);
                results.push(`è¿è¡Œç¯å¢ƒ: ${env.environmentLabel}`);
                results.push(`åè®®: ${env.protocol}`);
                results.push(`ä¸»æœº: ${env.host}`);
                results.push(`è·¯å¾„: ${env.path}`);
                
                // æ£€æµ‹æµè§ˆå™¨æ”¯æŒ
                const hasCamera = navigator.mediaDevices && navigator.mediaDevices.getUserMedia;
                results.push(`ç›¸æœºæ”¯æŒ: ${hasCamera ? 'âœ… æ”¯æŒ' : 'âŒ ä¸æ”¯æŒ'}`);
                
                const hasFetch = typeof fetch !== 'undefined';
                results.push(`Fetch API: ${hasFetch ? 'âœ… æ”¯æŒ' : 'âŒ ä¸æ”¯æŒ'}`);

                if (env.isFile) {
                    statusDiv.className = 'status error';
                    statusDiv.innerHTML = `
                        <strong>âŒ æ£€æµ‹åˆ°æœ¬åœ°ç¯å¢ƒ</strong><br>
                        ${results.join('<br>')}
                        <br><br>
                        <strong>é—®é¢˜ï¼š</strong>AI æ¥å£éœ€è¦éƒ¨ç½²åˆ° Vercel æ‰èƒ½å·¥ä½œï¼
                        <br>ä¸‹ä¸€æ­¥ï¼š${env.nextStep}
                    `;
                    showSolution('local');
                } else if (env.isLocalhost) {
                    statusDiv.className = 'status info';
                    statusDiv.innerHTML = `
                        <strong>âš ï¸ æ£€æµ‹åˆ°æœ¬åœ°æœåŠ¡å™¨</strong><br>
                        ${results.join('<br>')}
                        <br>ä¸‹ä¸€æ­¥ï¼š${env.nextStep}
                    `;
                    showSolution('local');
                } else if (env.isVercel) {
                    statusDiv.className = 'status success';
                    statusDiv.innerHTML = `
                        <strong>âœ… ç¯å¢ƒæ£€æµ‹é€šè¿‡</strong><br>
                        ${results.join('<br>')}
                        <br>ä¸‹ä¸€æ­¥ï¼š${env.nextStep}
                    `;
                } else if (env.isCustomDomain) {
                    statusDiv.className = 'status info';
                    statusDiv.innerHTML = `
                        <strong>âš ï¸ è‡ªå®šä¹‰åŸŸå</strong><br>
                        ${results.join('<br>')}
                        <br>ä¸‹ä¸€æ­¥ï¼š${env.nextStep}
                    `;
                    showSolution('custom');
                } else {
                    statusDiv.className = 'status info';
                    statusDiv.innerHTML = `
                        <strong>âš ï¸ æœªçŸ¥éƒ¨ç½²ç¯å¢ƒ</strong><br>
                        ${results.join('<br>')}
                    `;
                    showSolution('unknown');
                }
            }, 500);
        }

        // æ­¥éª¤2: API è¿é€šæ€§æµ‹è¯•
        async function testAPIConnection() {
            const statusDiv = document.getElementById('api-status');
            statusDiv.className = 'status pending';
            statusDiv.innerHTML = 'ğŸ” æ­£åœ¨æµ‹è¯• API è¿æ¥...';

            try {
                const response = await fetch('/api/analyze', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        image: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg=='
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }

                statusDiv.className = 'status success';
                statusDiv.innerHTML = `
                    <strong>âœ… API è¿æ¥æˆåŠŸï¼</strong><br>
                    æ¥å£å“åº”æ­£å¸¸ï¼Œå¯ä»¥è¿›è¡Œå›¾ç‰‡è¯†åˆ«æµ‹è¯•
                `;

            } catch (error) {
                statusDiv.className = 'status error';
                statusDiv.innerHTML = `
                    <strong>âŒ API è¿æ¥å¤±è´¥</strong><br>
                    é”™è¯¯ä¿¡æ¯: ${error.message}<br>
                    <br>
                    å¯èƒ½çš„åŸå› ï¼š<br>
                    1. æœªéƒ¨ç½²åˆ° Vercel<br>
                    2. API Key æœªé…ç½®<br>
                    3. ç½‘ç»œè¿æ¥é—®é¢˜
                `;
                showSolution('api-failed');
            }
        }

        // å¤„ç†å›¾ç‰‡ä¸Šä¼ 
        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                currentImage = e.target.result;
                const preview = document.getElementById('preview');
                preview.src = currentImage;
                preview.style.display = 'block';
                
                document.getElementById('testBtn').disabled = false;
                document.getElementById('test-status').className = 'status info';
                document.getElementById('test-status').innerHTML = 'âœ… å›¾ç‰‡å·²åŠ è½½ï¼Œç‚¹å‡»"å¼€å§‹è¯†åˆ«"è¿›è¡Œæµ‹è¯•';
            };
            reader.readAsDataURL(file);
        }

        // æ­¥éª¤3: å®é™…å›¾ç‰‡åˆ†ææµ‹è¯•
        async function testImageAnalysis() {
            if (!currentImage) {
                alert('è¯·å…ˆä¸Šä¼ å›¾ç‰‡ï¼');
                return;
            }

            const statusDiv = document.getElementById('test-status');
            const resultSection = document.getElementById('resultSection');
            const resultJson = document.getElementById('resultJson');
            const testBtn = document.getElementById('testBtn');

            statusDiv.className = 'status pending';
            statusDiv.innerHTML = 'ğŸ¤– æ­£åœ¨åˆ†æå›¾ç‰‡ï¼Œè¯·ç¨å€™...';
            testBtn.disabled = true;

            try {
                const response = await fetch('/api/analyze', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        image: currentImage
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();
                
                if (result.error) {
                    throw new Error(result.error);
                }

                // æ˜¾ç¤ºæˆåŠŸç»“æœ
                statusDiv.className = 'status success';
                statusDiv.innerHTML = `
                    <strong>âœ… è¯†åˆ«æˆåŠŸï¼</strong><br>
                    é¢œè‰²: ${result.color || 'æœªçŸ¥'} (${result.colorHex || ''})<br>
                    ç±»å‹: ${getCategoryName(result.category)}<br>
                    ç½®ä¿¡åº¦: ${(result.confidence * 100).toFixed(1)}%<br>
                    å­£èŠ‚: ${getSeasonName(result.suggestedSeason)}
                `;

                // æ˜¾ç¤ºå®Œæ•´ JSON
                resultSection.style.display = 'block';
                resultJson.textContent = JSON.stringify(result, null, 2);

                testBtn.disabled = false;

            } catch (error) {
                statusDiv.className = 'status error';
                statusDiv.innerHTML = `
                    <strong>âŒ è¯†åˆ«å¤±è´¥</strong><br>
                    é”™è¯¯ä¿¡æ¯: ${error.message}
                `;
                showSolution('analysis-failed');
                testBtn.disabled = false;
            }
        }

        // æ˜¾ç¤ºè§£å†³æ–¹æ¡ˆ
        function showSolution(type) {
            const solutionSection = document.getElementById('solutionSection');
            const solutionContent = document.getElementById('solutionContent');
            
            solutionSection.style.display = 'block';

            if (type === 'local') {
                solutionContent.innerHTML = `
                    <ol>
                        <li><strong>éƒ¨ç½²åˆ° Vercelï¼š</strong>
                            <ul>
                                <li>è®¿é—® <a href="https://vercel.com" target="_blank">vercel.com</a> å¹¶ç™»å½•</li>
                                <li>ç‚¹å‡» "New Project" â†’ å¯¼å…¥ä½ çš„ GitHub ä»“åº“</li>
                                <li>ç‚¹å‡» Deploy å®Œæˆéƒ¨ç½²</li>
                            </ul>
                        </li>
                        <li><strong>é…ç½® API Keyï¼š</strong>
                            <ul>
                                <li>åœ¨ Vercel é¡¹ç›®è®¾ç½®ä¸­æ‰¾åˆ° "Environment Variables"</li>
                                <li>æ·»åŠ å˜é‡: <code>SILICON_FLOW_API_KEY</code></li>
                                <li>å€¼ä¸º: <code>sk-gocqsbrafyqklzgiwmasvmonueucwlropzngfmfosfrodtjl</code></li>
                                <li>ä¿å­˜åé‡æ–°éƒ¨ç½²</li>
                            </ul>
                        </li>
                        <li><strong>æœ¬åœ°æµ‹è¯•ï¼ˆå¯é€‰ï¼‰ï¼š</strong>
                            <ul>
                                <li>å®‰è£… Vercel CLI: <code>npm i -g vercel</code></li>
                                <li>åœ¨é¡¹ç›®ç›®å½•è¿è¡Œ: <code>vercel dev</code></li>
                                <li>è®¿é—® <code>http://localhost:3000</code></li>
                            </ul>
                        </li>
                    </ol>
                `;
            } else if (type === 'custom') {
                solutionContent.innerHTML = `
                    <ol>
                        <li>åœ¨ Vercel æ§åˆ¶å°ç¡®è®¤æ­¤è‡ªå®šä¹‰åŸŸåå·²ç»ç»‘å®šï¼Œå¹¶æŒ‡å‘æœ€æ–°éƒ¨ç½²</li>
                        <li>è‹¥é¡µé¢ 404ï¼Œè¿›å…¥ Deployments é¡µé¢æ£€æŸ¥å½“å‰éƒ¨ç½²ä¸­æ˜¯å¦åŒ…å« <code>test-ai-api.html</code></li>
                        <li>å¿…è¦æ—¶ç‚¹å‡» Redeploy â†’ é€‰æ‹©æœ€æ–° commitï¼ˆä¾‹å¦‚ <code>fix ai2</code>ï¼‰å¹¶é‡æ–°éƒ¨ç½²</li>
                        <li>æ¸…ç†æµè§ˆå™¨ç¼“å­˜æˆ–ä½¿ç”¨éšç§æ¨¡å¼é‡æ–°è®¿é—®</li>
                    </ol>
                `;
            } else if (type === 'unknown') {
                solutionContent.innerHTML = `
                    <ol>
                        <li>ç¡®è®¤è®¿é—®åœ°å€æ˜¯å¦æ­£ç¡®ï¼Œå¦‚ <code>https://é¡¹ç›®å.vercel.app/test-ai-api.html</code></li>
                        <li>é€šè¿‡ <code>git status</code> ç¡®ä¿æœ€æ–°ä»£ç å·²æ¨é€åˆ° GitHub</li>
                        <li>åœ¨ Vercel ä¸­æŸ¥çœ‹ Deployments è®°å½•ï¼Œç¡®è®¤æœ€æ–° commit æˆåŠŸéƒ¨ç½²</li>
                    </ol>
                `;
            } else if (type === 'api-failed') {
                solutionContent.innerHTML = `
                    <ol>
                        <li>æ£€æŸ¥æ˜¯å¦å·²åœ¨ Vercel é…ç½®ç¯å¢ƒå˜é‡ <code>SILICON_FLOW_API_KEY</code></li>
                        <li>ç¡®è®¤é¡¹ç›®å·²æˆåŠŸéƒ¨ç½²åˆ° Vercel</li>
                        <li>æŸ¥çœ‹ Vercel éƒ¨ç½²æ—¥å¿—æ˜¯å¦æœ‰é”™è¯¯</li>
                        <li>å°è¯•åœ¨ Vercel é‡æ–°éƒ¨ç½²é¡¹ç›®</li>
                        <li>æ£€æŸ¥ API Key æ˜¯å¦æœ‰æ•ˆï¼ˆå¯èƒ½å·²è¿‡æœŸæˆ–é¢åº¦ç”¨å®Œï¼‰</li>
                    </ol>
                `;
            } else if (type === 'analysis-failed') {
                solutionContent.innerHTML = `
                    <ol>
                        <li>ç¡®è®¤å›¾ç‰‡æ ¼å¼æ­£ç¡®ï¼ˆæ”¯æŒ JPGã€PNGï¼‰</li>
                        <li>å›¾ç‰‡å¤§å°ä¸è¦è¶…è¿‡ 5MB</li>
                        <li>æ£€æŸ¥ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸</li>
                        <li>æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°æ˜¯å¦æœ‰è¯¦ç»†é”™è¯¯ä¿¡æ¯</li>
                        <li>å¦‚æœæ˜¯ API é…é¢é—®é¢˜ï¼Œå¯èƒ½éœ€è¦ç­‰å¾…æˆ–æ›´æ¢ API Key</li>
                    </ol>
                `;
            }
        }

        // è¾…åŠ©å‡½æ•°
        function getCategoryName(category) {
            const names = {
                'top': 'ä¸Šè¡£',
                'pants': 'è£¤è£…',
                'shoes': 'é‹å­',
                'accessory': 'é…é¥°'
            };
            return names[category] || category;
        }

        function getSeasonName(season) {
            const names = {
                'spring': 'æ˜¥å­£',
                'summer': 'å¤å­£',
                'autumn': 'ç§‹å­£',
                'winter': 'å†¬å­£',
                'all': 'å››å­£'
            };
            return names[season] || season;
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¿è¡Œç¯å¢ƒæ£€æµ‹
        window.addEventListener('load', () => {
            setTimeout(checkEnvironment, 500);
        });
    </script>
</body>
</html>
